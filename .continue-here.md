# Continue Here

- **Created**: 2026-02-20 ~12:00 AM CT
- **Task**: SPEC-001 complete, SPEC-002 implementation is next
- **Branch**: main

## What's Done This Session
- Pulled updated specs from Mac (rebased over 6 remote commits, resolved TODO.md conflict)
- Implemented all of SPEC-001 (8 files, 6 API routes):
  - `src/lib/api-types.ts` — 20 interfaces + FLAGGED_NDCS registry
  - `src/lib/parse-filters.ts` — parseFilters(URLSearchParams): FilterParams
  - `src/lib/build-where.ts` — buildWhereClause(FilterParams): {where, needsJoin}
  - `src/app/api/entities/route.ts` — simple SELECT from entities
  - `src/app/api/filters/route.ts` — 3 distinct-value queries with flagged NDC exclusion
  - `src/app/api/overview/route.ts` — 6 parallel queries (KPIs, unfilteredKpis, monthly, formulary, states, adjudication)
  - `src/app/api/claims/route.ts` — 8 parallel queries (KPIs, monthly, drugs with MODE(), daysSupply bins, MONY, topGroups, topManufacturers)
  - `src/app/api/anomalies/route.ts` — 4 investigation panels (Kryptonite XR, Sept spike, Nov dip, KS Aug batch reversal)
- Spec review passed: all 20 types match, all column refs verified against schema
- Integration smoke-tested all 6 routes against live Neon DB — all EDA oracle values match
- One bug found and fixed: Postgres can't reference column aliases inside CASE in ORDER BY (daysSupply query)
- All pushed to remote, TODO updated, Mac tagged to verify

## What's Remaining
- Mac to run `/verify 001` on SPEC-001 implementation
- Implement SPEC-002: FilterContext + FilterBar + URL sync + chip pills
- Implement SPEC-003: Executive Overview page (KPIs, hero chart, donut, bars, gauge, insight cards)
- Implement SPEC-004: Claims Explorer page (mini trend, drugs table, days supply, MONY, groups, manufacturers)
- Install missing shadcn components: `npx shadcn@latest add command popover switch skeleton`

## In-Progress State
- `.claude/settings.json` modified (hook paths for Framework Desktop — intentionally local-only, don't commit)
- `docs/plans/2026-02-20-spec-001-api-routes.md` untracked (implementation plan, can commit or leave)
- All SPEC-001 code committed and pushed
- Dev server not running (stopped after smoke tests)

## Decisions Made This Session
- **Raw SQL over Drizzle query builder for routes**: `db.execute(sql\`...\`)` with Drizzle's `sql` tagged template for parameterization. Drizzle's query builder doesn't compose well with dynamic WHERE fragments for this use case. Each route has a local `buildRawWhere()` helper for SQL composition (the shared `buildWhereClause` from build-where.ts is for Drizzle's query builder API — routes use raw SQL instead).
- **Promise.all for parallel queries**: Overview runs 6 queries in parallel, Claims runs 8, Anomalies runs batched parallel sets. Significant latency reduction.
- **Subagent permissions issue**: Background subagents couldn't use Write/Bash tools. Workaround: subagents designed the code, controller (main agent) wrote files and committed. Still faster than sequential because subagents ran in parallel.
- **Postgres ORDER BY alias limitation**: Can't use column alias inside CASE in ORDER BY. Fixed with `ORDER BY MIN(c.days_supply)` which naturally sorts bins correctly.
- **Monthly grouping**: Used `TO_CHAR(date_filled, 'YYYY-MM')` instead of `date_trunc('month', ...)` — produces the string format directly without extra formatting.

## Next Action
Read SPEC-002 (`docs/specs/SPEC-002-filter-context.md`), run `/spec-check 002` if not already done, then write implementation plan and start building. First file will be the FilterContext provider (`src/contexts/filter-context.tsx`) — React context with URL search param sync, then the FilterBar component.

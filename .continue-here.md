# Continue Here

- **Created**: 2026-02-20, afternoon (Mac)
- **Task**: SPEC-003 filter bugs fixed, SPEC-004 prompt written, SPEC-005 writing next
- **Branch**: main (up to date with origin)

## What's Done This Session

1. **Killed date picker** — removed both `<input type="date">` elements from filter-bar.tsx. Month-click on hero chart remains the only date filter mechanism.
2. **Fixed missing-months chart bug** — added `fillAllMonths()` in `src/lib/format.ts`. API returns no row for months with 0 claims (e.g. May when Kryptonite excluded for KS/MN/PA). Without fill, chart interpolated over the gap. Now shows zero correctly.
3. **Fixed misleading KPI deltas** — replaced entire delta system with share-of-total subtitles:
   - Count metrics show "X% of total" (e.g. "28.5% of total")
   - Reversal rate shows "overall: 10.8%"
   - Unique drugs shows "X% of formulary"
   - No more "vs avg" (was dividing total by dimension count — meaningless for non-uniform distributions)
4. **Fixed chart label clipping** — increased top margin from 10px to 24px on monthly area chart so "Sep +41%" and "Nov −54%" reference line labels aren't cut off.
5. **Replaced adjudication gauge** — semicircle wasted space. Now: big stat + horizontal progress bar + legend counts + context note.
6. **Wrote SPEC-004 implementation prompt** at `docs/prompts/SPEC-004-implementation.md` — covers all filter bar fixes, data fetching pattern, cross-filtering patterns, `fillAllMonths`, `formatPercent` 0-100 convention, smoke test checklist.
7. **Generated Framework prompt** — ready to paste for SPEC-004 implementation.

## What's Remaining

1. **Write SPEC-005** — Anomalies & Recommendations page. Design doc is locked at `docs/plans/2026-02-20-spec-005-design.md`. Needs formal numbered ACs (~15-18).
2. **Brainstorm + write SPEC-006** — AI Process page
3. **Brainstorm + write SPEC-007** — "Ask the Data" chat sidebar
4. **Verify SPEC-004** when Framework implements it

## Key Decisions This Session

- **Date picker killed**: month-click on chart is sufficient for sub-year drilling. Date filter params (`dateStart`/`dateEnd`) still exist in URL/context for the month-click feature.
- **KPI deltas replaced with shares**: "vs avg" assumed uniform distribution (total/N) which was never true. Shares are always honest. Reversal rate shows unfiltered baseline as context.
- **Unique Drugs delta dropped entirely**: non-additive metric — share of formulary is the only meaningful comparison.
- **Adjudication gauge → horizontal bar**: semicircle gauge wasted vertical space, looked sparse. Horizontal bar fills card width naturally.

## Next Action

Write the formal SPEC-005 spec at `docs/specs/SPEC-005-anomalies-recommendations.md`. Start by reading the locked design doc at `docs/plans/2026-02-20-spec-005-design.md`. The spec needs:

1. Problem statement (editorial storytelling page, consumes `/api/anomalies`)
2. Behavior section with the full page layout from the design doc
3. Investigation panel card anatomy (hero stat, narrative, mini charts, before/after, footer)
4. COVID context banner content
5. Follow-up questions content (all 3 tabs, exact questions from design doc)
6. Extension mock-up specs (4 panels, visual treatment, narrative content)
7. File structure (new components directory `src/components/anomalies/`)
8. Numbered ACs — target ~15-18
9. Non-goals (no filtering, no real data in extensions, no mobile)

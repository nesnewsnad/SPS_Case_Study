# Continue Here

**Created**: 2026-02-21 ~02:00 EST (Framework Desktop)
**Task**: Production hardening — 11-task implementation plan ready, no code written yet
**Branch**: main (clean, up to date with origin)

## What's Done This Session

1. **Brainstorming complete** — explored codebase for existing hardening (none), locked scope with user: both code-review optics AND live demo protection, comprehensive time budget, layer-by-layer approach
2. **Design doc written and committed** — `docs/plans/2026-02-21-production-hardening-design.md` — 4 layers: infrastructure (headers + middleware), data (Zod + cache + DB retry), UI (error boundaries + XSS + loading), performance (font-display + skip-to-content)
3. **Implementation plan written and committed** — `docs/plans/2026-02-21-production-hardening-plan.md` — 11 tasks with exact code, file paths, and verification steps
4. **Rebased on Mac's 3 new commits** — data findings corrections, checkpoint cleanup, session log. Only conflict was `.continue-here.md` (deleted on remote).

## What's Remaining

**All 11 implementation tasks (zero code written):**

| Task | What                               | Files                                                        |
| ---- | ---------------------------------- | ------------------------------------------------------------ |
| 1    | Install zod + isomorphic-dompurify | package.json                                                 |
| 2    | Security headers in next.config.ts | next.config.ts                                               |
| 3    | Rate-limited middleware            | src/middleware.ts (new)                                      |
| 4    | Zod validation schemas             | src/lib/validation.ts (new), parse-filters.ts, chat/route.ts |
| 5    | Cache headers on 5 API routes      | overview, claims, anomalies, filters, entities route files   |
| 6    | DB retry wrapper                   | src/lib/db-utils.ts (new), anomalies/route.ts                |
| 7    | Error boundaries                   | src/app/error.tsx (new), global-error.tsx (new)              |
| 8    | Loading skeleton                   | src/app/loading.tsx (new)                                    |
| 9    | XSS fix + ARIA                     | src/components/chat-sidebar.tsx                              |
| 10   | Font display + skip link           | src/app/layout.tsx                                           |
| 11   | Final build verification           | —                                                            |

## Decisions Made This Session

- **Cut dynamic chart imports** — causes visible layout shift (CLS) when charts pop in after hydration. Worse UX for a demo dashboard where charts ARE the primary content. Lighthouse score gain (~10-15pts) not worth the visual regression.
- **In-memory rate limiting (not distributed)** — `Map<string, number[]>` resets on cold start. Sufficient for demo protection + shows the pattern. No Redis/external dependency needed.
- **Zod validation falls back to defaults on invalid input** — doesn't return 400 on data routes (would break the dashboard). Only chat route returns 400 on invalid input.
- **DOMPurify over markdown renderer for chat XSS** — 1-line fix at each `dangerouslySetInnerHTML` call site vs. replacing the entire formatting pipeline
- **DB retry only on anomalies route** — demonstrates the pattern without adding noise to every route. Anomalies has the heaviest queries (most likely to cold-start timeout).

## Next Action

Start executing the plan. Open `docs/plans/2026-02-21-production-hardening-plan.md` and begin with Task 1: `npm install zod isomorphic-dompurify && npm install --save-dev @types/dompurify`. Use subagent-driven execution (superpowers:subagent-driven-development) for fresh subagent per task with review between tasks.

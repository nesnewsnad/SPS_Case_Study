# Continue Here

**Created**: 2026-02-19 evening
**Task**: Spec-check fixes — SPEC-003 and SPEC-004 remaining
**Branch**: main (3 commits ahead of origin, not pushed)

## What's Done This Session

1. Fresh comprehensive EDA against raw CSVs — discovered Kryptonite XR test drug + KS August batch reversal
2. Amended all 4 specs for flagged NDC toggle + corrected anomaly narratives (+41% Sep, -54% Nov)
3. Wrote 69 pytests codifying all EDA findings as data contracts (all passing)
4. Spec-check SPEC-001 → fixed: 3 new ACs (14-16), clarified buildWhereClause return type, unfilteredKpis + flagged interaction, /api/filters flagged behavior, MODE() implementor note
5. Spec-check SPEC-002 → fixed: AC2 added toggleFlaggedNdcs, AC6/AC19 contradiction resolved, AC8 switched to router.push() with debounce, AC15 measurable 200ms, AC18 locked amber treatment, AC20 fetch error handling, Prerequisites section for missing shadcn components
6. Spec-check SPEC-003 → findings captured but NOT yet fixed
7. Spec-check SPEC-004 → findings captured but NOT yet fixed
8. TODO.md updated with all completed items

## What's Remaining

### SPEC-003 fixes (READY WITH NOTES → READY):
- **AC4**: Delta formula underspecified — clarify dimension counts for date range (12), groupId (use full unfiltered comparison), and multi-filter behavior (compare against full unfiltered value, label says "vs avg" → "vs total" or just "vs avg" for all)
- **AC7**: Permits two month-click implementations — pick one or accept both
- **AC11**: Missing dynamic adjudication context note variant
- **AC12**: "consultant-analyst tone" subjective — add minimum template count (e.g., "at least 15 templates covering: unfiltered, per-state, per-month, per-formulary, per-MONY")
- **AC16**: "formatted values" vague — reference Behavior section per-chart specs
- **Non-goals**: Add "Dark mode theming" to prevent scope creep
- **Cross-cutting**: Document that SPEC-003 owns creation of `generate-insights.ts` and `format.ts`

### SPEC-004 fixes (READY WITH NOTES → READY):
- **AC4**: Tighten mini trend — add height (~150px) and stacked-area requirement
- **AC14**: "filter-responsive content" needs minimum template count
- **Must resolve**: @tanstack/react-table contradiction (installed but spec says custom logic)
- **Add AC**: Mini trend cross-filtering (click month → date filter)
- **Clarify**: KPI data fetched but not rendered — document in non-goals or add to layout
- **Document**: SPEC-004 extends `generateInsights` from SPEC-003, doesn't own it
- **Optional**: Resolve Days Supply cross-filter ambiguity, shared color constants

### After spec fixes:
- Push all commits to origin
- Vercel setup happening on Framework side in parallel
- Implementation begins (SPEC-001 + SPEC-002 in parallel, then SPEC-003 + SPEC-004)

## Decisions Made This Session

- **router.push() over router.replace()**: Debounced push creates one history entry per 200ms window. Enables meaningful back/forward without flooding. Resolved the AC8 contradiction.
- **Amber toggle treatment locked**: Label text changes to "Flagged NDCs included" with `text-amber-600`. No background color change. Measurable.
- **unfilteredKpis respects flagged toggle**: It's a data-quality control, not a dimension filter. Clean dataset (~546K) when flagged off, full dataset (~596K) when on.
- **No input validation on API routes**: Invalid filter values return empty results. Only try/catch for 500 errors. Simplifies implementation.
- **buildWhereClause returns `{ where, needsJoin }`**: Or implementor can just always JOIN (drug_info is small). Either approach acceptable.

## Next Action

Open `docs/specs/SPEC-003-executive-overview.md` and fix the 7 items listed under "SPEC-003 fixes" above. Specifically:
1. Rewrite AC4 to specify dimension counts: state=5, formulary=3, mony=4, month=12, and multi-filter uses full unfiltered value (not per-dimension avg)
2. Tighten AC7 to accept either month-click approach
3. Add dynamic note variant to AC11
4. Add minimum template count to AC12 (>= 15 templates)
5. Reference Behavior section tooltip specs in AC16
6. Add "Dark mode theming" to Non-Goals
7. Add note that SPEC-003 owns `generate-insights.ts` and `format.ts` creation
Then commit, move to SPEC-004 fixes.

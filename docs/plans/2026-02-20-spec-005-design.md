# SPEC-005 Design — Anomalies & Recommendations Page

**Date:** 2026-02-20
**Brainstormed by:** Mac + Dan
**Status:** Design complete, ready for spec writing

---

## Scope

Single combined spec covering the entire Anomalies & Recommendations view:
- 4 investigation panels (Kryptonite hero + 3 supporting)
- Follow-up questions (3 tabs)
- 4 extension mock-up panels

No FilterBar on this page — the anomaly investigations are editorial content about the full dataset, not filterable views. Adding filters would often lead to no content.

---

## Page Structure (vertical scroll)

```
┌─────────────────────────────────────────────────────────┐
│ Page Header                                              │
│ "Anomalies & Recommendations"                            │
│ "Pharmacy A — 2021 Claims Investigation"                 │
├─────────────────────────────────────────────────────────┤
│ COVID Context Banner                                     │
│ 2021 context callout — LTC census recovery, staffing     │
│ disruptions, retrospective billing backlogs              │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ ┌── HERO: Kryptonite XR (full-width) ────────────────┐  │
│ │ Key stat top-right: "49,567 claims"                 │  │
│ │ "What We See" narrative                             │  │
│ │ Mini chart + Before/After comparison table          │  │
│ │ Footer: Why It Matters | To Confirm | RFP Impact    │  │
│ └────────────────────────────────────────────────────┘  │
│                                                          │
│ ┌── September Spike ──────┐ ┌── November Dip ────────┐  │
│ │ Key stat: "+41%"        │ │ Key stat: "-54%"        │  │
│ │ Narrative + mini charts │ │ Narrative + mini charts │  │
│ │ Footer row              │ │ Footer row              │  │
│ └─────────────────────────┘ └─────────────────────────┘  │
│                                                          │
│ ┌── KS August Batch Reversal (full-width) ────────────┐  │
│ │ Key stat: "81.6%"                                    │  │
│ │ Narrative + grouped-bar chart (needs horizontal room)│  │
│ │ Footer row                                           │  │
│ └────────────────────────────────────────────────────┘  │
│                                                          │
├─────────────────────────────────────────────────────────┤
│ Follow-Up Questions                                      │
│ ┌───────────────────────────────────────────────────┐   │
│ │ [Client] [Internal] [Data Requests]  ← tabs       │   │
│ │ Bulleted questions in active tab                   │   │
│ └───────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────┤
│ What's Next — Proposed Extensions                        │
│                                                          │
│ ┌─ PROPOSED ─────────────┐ ┌─ PROPOSED ──────────────┐  │
│ │ Client Onboarding &    │ │ Pricing & Reimbursement │  │
│ │ Comparison             │ │ Overlay                 │  │
│ └────────────────────────┘ └─────────────────────────┘  │
│ ┌─ PROPOSED ─────────────┐ ┌─ PROPOSED ──────────────┐  │
│ │ Automated Anomaly      │ │ Therapeutic Class       │  │
│ │ Detection              │ │ Analysis                │  │
│ └────────────────────────┘ └─────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## Section 1: Investigation Panels

### Layout Rules

- **Kryptonite XR** = full-width hero card (visually larger/more prominent)
- **September Spike + November Dip** = side-by-side (both are volume anomalies, natural pair)
- **KS August Batch Reversal** = full-width (grouped-bar chart needs horizontal room)

### Card Anatomy (all 4 panels)

Same card design for all panels, Kryptonite just has an extra before/after table slot:

```
┌─ Investigation Panel ────────────────────────────────┐
│                                                       │
│  TITLE                                    KEY STAT    │
│  ───────────────────────────────────────────────────  │
│                                                       │
│  What We See                                          │
│  [2-3 sentence narrative, muted text]                 │
│                                                       │
│  ┌─ Mini Chart ─────────┐  ┌─ Before / After ──────┐ │
│  │                       │  │ (Kryptonite only)     │ │
│  │  chart renders here   │  │ With / Without table  │ │
│  │                       │  │                       │ │
│  └───────────────────────┘  └───────────────────────┘ │
│                                                       │
│  ┌─────────────────────────────────────────────────┐  │
│  │ Why It Matters   │ To Confirm       │ RFP Impact│  │
│  │ [subdued text]   │ [subdued text]   │ [subdued] │  │
│  └─────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────┘
```

Design levers to keep it clean:
- Big key stat top-right as visual anchor
- "What We See" is the only prominent narrative (the lede)
- Mini charts + before/after table in middle band (visual evidence)
- Footer row is subdued: smaller text, muted foreground, lighter weight
- Generous padding, single border card, no shadows/gradients/nested cards

### Before/After Table (Kryptonite only)

| Metric | With Test Drug | Without |
|--------|---------------|---------|
| Total Claims | 596,090 | 546,523 |
| May Volume | 49,806 | 5 |
| Net Claims | varies | varies |
| Reversal Rate | X.X% | X.X% |
| Unique Drugs | X,XXX | X,XXX |

Data comes from `panel.beforeAfter` array in the API response. Other panels don't have this field — the slot simply doesn't render.

### MiniChart Component

One flexible `<MiniChart>` component that switches on `type`:

```typescript
interface MiniChartProps {
  title: string;
  type: 'bar' | 'grouped-bar' | 'stacked-bar';
  data: Record<string, number | string>[];
}
```

- ~200px height, fits inside investigation card
- Uses Recharts BarChart with layout variations per type
- Single dynamic import, single Skeleton loader
- Renders whatever the API returns — component doesn't know about anomaly specifics

### Data Source

`GET /api/anomalies?entityId=1` — already implemented (SPEC-001). Returns `AnomaliesResponse` with 4 panels, each containing `miniCharts[]`, narrative strings, and optional `beforeAfter[]`.

No filter params passed — this page shows the full-dataset investigation.

---

## Section 2: COVID Context Banner

Positioned between page header and investigation panels. A subtle callout card (info severity — teal left border):

> **2021 Context:** LTC pharmacies were operating through post-COVID census recovery, staffing disruptions, and retrospective billing backlogs. These factors should be considered when interpreting volume anomalies — particularly the September spike and November dip.

Static content, no API dependency.

---

## Section 3: Follow-Up Questions

A shadcn Card with a Tabs component inside. Three tabs:

### Client Questions (for Pharmacy A)

1. Is NDC 65862020190 (Kryptonite XR) a known test record? Should it be added to a permanent exclusion table?
2. The 18 Kansas "400xxx" groups show a classic NCPDP reversal-and-rebill pattern in August — was this a contract renegotiation, MAC list update, or claims reprocessing event?
3. Did September's +41% spike reflect a post-COVID retrospective billing catch-up, new facility admissions as LTC census recovered, or Q3 reprocessing?
4. Was November's -54% dip related to the late-2021 staffing crisis, a COVID outbreak reducing census, or a data processing delay?
5. Are the 30 unmatched NDCs OTC products, compound codes, or DME items billed through the pharmacy channel?
6. Are DAW (Dispense as Written) codes available? The 77% generic rate suggests strong formulary management, but DAW codes would confirm whether brand dispensing is physician-directed or patient-requested.

### Internal Questions (for SPS)

1. Should batch reversal events (like KS August) trigger an automated flag during claims ingestion? A simple rule: if any group hits >50% reversal rate in a month, surface for review.
2. Do we maintain a test-NDC exclusion list across clients, or is this Pharmacy A-specific?
3. The 75% non-adjudicated rate is expected for LTC retrospective billing — but do we have reject reason codes? That would separate "not adjudicated at POS" from "rejected and resubmitted."
4. Should we benchmark this client's generic dispensing rate (77%) against our LTC book of business? That's a strong talking point if it's above or below market.
5. For the RFP response, should we model the cost impact of the reversal patterns? Reversed-and-rebilled claims often indicate pricing disputes or MAC list changes.

### Data Requests (next steps)

1. NDC master with GPI (Generic Product Identifier) codes and therapeutic class — enables formulary tier analysis and therapeutic substitution opportunities
2. Ingredient cost, AWP, and reimbursement data — the pricing layer is where PBM value is demonstrated (spread analysis, MAC compliance, generic effective rate)
3. Historical claims (2019-2020) — year-over-year trend, seasonal normalization, and pre/post-COVID utilization shifts
4. DAW codes and pharmacy NPI — enables generic substitution analysis and network performance benchmarking
5. Reject/denial codes from the adjudication system — separates clean claims from rework, quantifies first-pass resolution rate
6. Facility-level identifiers — enables per-facility benchmarking within groups

All static content. No API dependency.

---

## Section 4: Extension Mock-Ups

### Visual Treatment

- **Dashed border** (not solid) — universal mock-up signifier
- **"PROPOSED EXTENSION" badge** top-right, muted chip style
- **Two-column layout per card**: left = purpose-specific skeleton UI illustration, right = 2-3 paragraph written narrative
- Same card patterns, colors, typography as rest of dashboard
- **2x2 grid** layout

### Panel 1: Client Onboarding & Comparison

**Skeleton illustration:** Mini split-view showing two blurred/skeleton KPI rows side by side with "Pharmacy A" / "Pharmacy B" labels and a subtle upload icon.

**Narrative:** The multi-entity architecture is already in place — every claims record includes an `entity_id` foreign key, and the API routes accept entity-scoped queries. Onboarding a second pharmacy client means: CSV upload → automated ingestion → side-by-side KPI comparison, overlay trend charts, and benchmarked reversal rates. The infrastructure exists; it's waiting for the data.

### Panel 2: Pricing & Reimbursement Overlay

**Skeleton illustration:** A skeleton area chart with a translucent cost overlay layer and "$ AWP / MAC" axis label.

**Narrative:** Utilization analysis tells half the story — the other half is cost. With ingredient cost, AWP, and reimbursement data, this dashboard would surface: generic effective rate vs contracted rate, MAC compliance by drug, spread analysis by formulary tier, and cost-per-claim trending. This is where PBM value is measured and where RFP pricing commitments are validated against actual claims experience.

### Panel 3: Automated Anomaly Detection

**Skeleton illustration:** A mini monthly trend line with pulsing dot markers at Sept/Nov positions and a flag icon.

**Narrative:** The four anomalies identified in this analysis were found through manual investigation. In production, a statistical engine would flag these automatically on ingestion: volume deviations beyond 2 standard deviations, reversal rate spikes by group, test/dummy NDC detection via drug reference cross-check, and seasonal pattern breaks. Each flag would generate an investigation card like the ones above — same format, zero manual effort.

### Panel 4: Therapeutic Class Analysis

**Skeleton illustration:** A skeleton horizontal bar chart with therapeutic class labels (Cardiovascular, GI, Pain Management, Anticoagulants) and grouped color bars.

**Narrative:** Mapping NDCs to GPI (Generic Product Identifier) codes unlocks therapeutic category analysis: formulary concentration by drug class, therapeutic duplication detection (multiple drugs in same class for same indication), generic substitution opportunity quantification, and high-cost specialty drug exposure. For LTC populations, this reveals whether the formulary is optimized for the chronic conditions typical of elderly care — cardiovascular, GI, pain management, and anticoagulation.

---

## Design Decisions Log

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Combined spec | SPEC-005 = anomalies + extensions + follow-ups | Same page, same route, shared layout context |
| No FilterBar | Skip | Static editorial content; filtering often yields no results |
| Page layout | Vertical scroll | "Tell a story" — reads top to bottom like a report |
| Investigation cards | Always-open | Evaluator sees analytical depth immediately |
| Kryptonite | Full-width hero | The headline finding, evaluator's litmus test |
| Sept + Nov | Side-by-side | Natural pair (both volume anomalies) |
| KS August | Full-width | Grouped-bar chart needs horizontal room |
| Card footer | Subdued 3-column | Present but not screaming — like report footnotes |
| MiniChart | One flexible component | Switches on type (bar/grouped-bar/stacked-bar) |
| COVID context | Banner on page | Shows domain awareness for 2021 LTC data |
| Follow-up questions | 3-tab card | PBM-expert language, COVID-aware framing |
| Extension mock-ups | Dashed border + badge + skeleton UI | Clearly "proposed" while looking 80% built |
| Extension ordering | Onboarding, Pricing, Anomaly Detection, Therapeutic Class | Lead with provable architecture, end with standard asks |
| Patient Demographics | Replaced with Therapeutic Class | Avoids HIPAA optics, stronger PBM domain signal |
| Visual language | Same as SPEC-003/004 | Cohesiveness now, frontend-design skill on Sunday polish pass |
